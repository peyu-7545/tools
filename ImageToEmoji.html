<!DOCTYPE html>
<html lang="ja">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ImageToEmoji</title>
    <style>
        html {
            width: 100vw;
            height: 100vh;
        }

        body {
            margin: 0;
            height: 100%;
            padding: 4px;
            overflow: hidden;
            display: grid;
            grid-template-rows: 4em 2em auto 1fr;
            background-color: #f0f0f0;
        }

        hr {
            margin: 4px 0;
        }

        h1 {
            margin: 0;
        }

        input[type=number] {
            width: 50px;
        }

        button {
            cursor: pointer;
            border-radius: 5px;
            border: 1px solid black;
        }

        #inputArea {
            display: flex;
            column-gap: 15px;
        }

        #outputArea {
            white-space: nowrap;
            font-size: 5px;
            padding: 0 2px;
            overflow: scroll;
        }

        #result {
            margin: 0;
            letter-spacing: -0.2em;
            line-height: 1em;
        }
    </style>
</head>

<body>
    <h1>ÁµµÊñáÂ≠ó„Ç≥„É≥„Éê„Éº„Çø</h1>
    <div id="inputArea">
        <input type="file" accept="image/*" />
        <span>Ê®™ÂπÖ:<input type="number" min="0" />ÊñáÂ≠ó</span>
        <span>ÊñáÂ≠ó„Çµ„Ç§„Ç∫:<input type="number" min="0" />px</span>
        <button id="copyBtn">ÁµµÊñáÂ≠ó„Çí„Ç≥„Éî„Éº</button>
        <button id="downloadBtn">ÁµµÊñáÂ≠ó„Çí„ÉÄ„Ç¶„É≥„É≠„Éº„Éâ</button>
    </div>
    <hr>
    <div id="outputArea">
        <p id="result"></p>
    </div>
    <script>
        const [fileInput, colInput, fontSizeInput] = document.querySelectorAll("input");
        const canvas = new OffscreenCanvas(0, 0);
        const ctx = canvas.getContext("2d", { willReadFrequently: true });
        const result = document.getElementById("result");
        const outputArea = document.getElementById("outputArea");
        const copyBtn = document.getElementById("copyBtn");
        const downloadBtn = document.getElementById("downloadBtn");
        const IMG_SIZE = 512;
        const emoji = [
            { char: "üü•", color: [221, 46, 68] },
            { char: "üüß", color: [255, 153, 0] },
            { char: "üü®", color: [255, 205, 46] },
            { char: "üü©", color: [125, 180, 64] },
            { char: "üü¶", color: [18, 119, 211] },
            { char: "üü™", color: [172, 69, 189] },
            { char: "‚¨õ", color: [64, 64, 64] },
            { char: "‚¨ú", color: [225, 225, 225] },
            { char: "üü´", color: [184, 109, 83] },
        ];
        let col = 100;
        let fontSize = 5;

        colInput.value = col;
        fontSizeInput.value = fontSize;

        fileInput.oninput = cvtImg;

        colInput.oninput = () => {
            col = colInput.value;
            cvtImg();
        }

        copyBtn.onclick = () => {
            const str = result.innerText;
            if (!str) {
                copyBtn.innerHTML = `„Ç≥„Éî„ÉºÂØæË±°„Åå„ÅÇ„Çä„Åæ„Åõ„Çì`;
                setTimeout(() => {
                    copyBtn.innerHTML = `ÁµµÊñáÂ≠ó„Çí„Ç≥„Éî„Éº`;
                });
                return;
            }
            navigator.clipboard.writeText(result.innerText);
            copyBtn.innerHTML = `„Ç≥„Éî„Éº„Åó„Åæ„Åó„Åü`;
            setTimeout(() => {
                copyBtn.innerHTML = `ÁµµÊñáÂ≠ó„Çí„Ç≥„Éî„Éº`;
            }, 1000);
        }

        downloadBtn.onclick = () => {
            const str = result.innerText;
            if (!str) {
                downloadBtn.innerHTML = `„ÉÄ„Ç¶„É≥„É≠„Éº„ÉâÂØæË±°„Åå„ÅÇ„Çä„Åæ„Åõ„Çì`;
                setTimeout(() => {
                    downloadBtn.innerHTML = `ÁµµÊñáÂ≠ó„Çí„ÉÄ„Ç¶„É≥„É≠„Éº„Éâ`;
                });
                return;
            }
            const link = document.createElement('a');
            link.href = URL.createObjectURL(new Blob([result.innerText], { type: "text/plain" }));
            link.download = 'emoji.txt';
            link.click();
            downloadBtn.innerHTML = `„ÉÄ„Ç¶„É≥„É≠„Éº„Éâ„Åó„Åæ„Åó„Åü`;
            setTimeout(() => {
                downloadBtn.innerHTML = `ÁµµÊñáÂ≠ó„Çí„ÉÄ„Ç¶„É≥„É≠„Éº„Éâ`;
            });
        }

        fontSizeInput.oninput = () => {
            outputArea.style.fontSize = `${fontSizeInput.value}px`;
        }

        function cvtImg() {

            // „Éï„Ç°„Ç§„É´„ÇíË™≠„ÅøËæº„ÇÄ
            const file = fileInput.files[0];
            if (!file) return;

            // „Éï„Ç°„Ç§„É´„É™„Éº„ÉÄ„Éº„Å®ÁîªÂÉè„ÇíÂàùÊúüÂåñ
            const reader = new FileReader();
            const img = new Image();

            // „Éï„Ç°„Ç§„É´„ÇíË™≠„ÅøËæº„ÇÄ
            reader.readAsDataURL(file);

            // Ë™≠„ÅøËæº„ÅøÁµÇ„Çè„Å£„Åü„Çâ
            reader.onload = () => {

                // ÁîªÂÉè„ÅÆ„ÇΩ„Éº„Çπ„Å´ÊåáÂÆö„Åô„Çã
                img.src = reader.result;

                // ÁîªÂÉè„ÅåË™≠„ÅøËæº„ÅøÁµÇ„Çè„Å£„Åü„Çâ
                img.onload = () => {

                    let cw, ch

                    // Â§âÊèõÂæå„ÅÆÊñáÂ≠óÂàó
                    let str = "";

                    const aspectRatio = img.width / img.height;

                    if (aspectRatio < 1) {
                        cw = IMG_SIZE * aspectRatio;
                        ch = IMG_SIZE;
                    } else {
                        cw = IMG_SIZE;
                        ch = IMG_SIZE / aspectRatio;
                    }

                    // „Ç≠„É£„É≥„Éê„Çπ„ÅÆÂ§ß„Åç„Åï„ÇíÂ§â„Åà„Çã
                    canvas.width = cw |= 0;
                    canvas.height = ch |= 0;

                    // ÁîªÂÉè„ÇíÊèèÁîª„Åô„Çã
                    ctx.drawImage(img, 0, 0, cw, ch);

                    // ÁîªÂÉè„ÇíÂèñÂæó„Åô„Çã
                    const data = ctx.getImageData(0, 0, cw, ch).data;

                    // ÁîªÂÉè„ÇíÊ∂à„Åô
                    ctx.clearRect(0, 0, cw, ch);

                    // ÊñáÂ≠ó„Çµ„Ç§„Ç∫„Å®‰∏ÄÊñáÂ≠óÂΩì„Åü„Çä„ÅÆ„Éî„ÇØ„Çª„É´Êï∞„ÄÅË°å„ÅÆÊï∞„ÇíÊ±Ç„ÇÅ„Çã
                    const charSize = cw / col;
                    const num = charSize * charSize;
                    const row = ch / charSize | 0;

                    // xyÂ∫ßÊ®ô„ÅßËâ≤„ÇíÂèñÂæó„Åô„ÇãÈñ¢Êï∞
                    function positionToIndex(x, y) {
                        const i = (y * cw + x) * 4;
                        return [data[i], data[i + 1], data[i + 2]];
                    }

                    // ÂÖ®„Å¶„ÅÆÊñáÂ≠ó„Å´ÂØæ„Åó„Å¶Âá¶ÁêÜ
                    for (let y = 0; y < row; y++) {
                        for (let x = 0; x < col; x++) {

                            // ÊñáÂ≠ó„Çµ„Ç§„Ç∫
                            const [r, g, b] = positionToIndex(Math.round((x + 0.5) * charSize), Math.round((y + 0.5) * charSize));

                            // ÊúÄÂ∞èÂÄ§
                            const min = { char: undefined, value: Infinity };

                            // ÂÖ®„Å¶„ÅÆÁµµÊñáÂ≠ó„Å´ÂØæ„Åó„Å¶Âá¶ÁêÜ
                            for (e of emoji) {

                                // ÁµµÊñáÂ≠ó„ÅÆ„Å®„ÅÆËâ≤„ÅÆÂ∑Æ„ÇíÊ±Ç„ÇÅ„Çã
                                const [R, G, B] = e.color;
                                const dist = (R - r) * (R - r) + (G - g) * (G - g) + (B - b) * (B - b);

                                // „Åì„Çå„Åæ„Åß„ÅÆÁµµÊñáÂ≠ó„Çà„Çä„ÇÇÂ∞è„Åï„Åã„Å£„Åü„ÇâÊõ¥Êñ∞
                                if (min.value > dist) {
                                    min.value = dist;
                                    min.char = e.char;
                                }
                            }

                            // ÊúÄ„ÇÇËøë„ÅÑÊñáÂ≠ó„ÇíËøΩÂä†
                            str += min.char;
                        }

                        // ÊîπË°å
                        str += "\n";
                    }

                    // Êõ¥Êñ∞
                    result.innerText = str;
                }
            }
        }
    </script>
</body>

</html>